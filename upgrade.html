<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade - VoidX Security Labs</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <header>
        <div class="logo">VOIDX SECURITY LABS</div>
        <nav class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="courses.html">Courses</a>
            <a href="labs.html">Labs</a>
            <a href="tools.html">Tools</a>
            <a href="community.html">Community</a>
            <a href="upgrade.html">Upgrade</a>
            <div class="user-info auth-required">
                <span class="user-email"></span> | 
                <span class="user-role"></span> | 
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="terminal-container">
            <div class="terminal-header">
                <div class="terminal-title">SUBSCRIPTION UPGRADE TERMINAL</div>
            </div>
            <div class="terminal-output" id="terminal-output">
                <div><span class="terminal-text">Loading subscription options...</span></div>
                <div><span class="terminal-text">Current level: <span id="current-level">FREE</span></span></div>
                <div><span class="terminal-text">Type "help" for available commands.</span></div>
                <br>
            </div>
            <div class="terminal-input">
                <span class="terminal-prompt">user@voidx:~$</span>
                <input type="text" class="terminal-input-field" placeholder="Type a command..." id="terminal-input">
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Subscription Plans</h2>
            <div class="card-content">
                <p>Choose a plan that fits your cybersecurity learning needs.</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin: 1.5rem 0;">
            <div class="card" style="border: 1px solid var(--accent-primary);">
                <h2 class="card-title">Free</h2>
                <div class="card-content">
                    <h3 style="color: var(--accent-primary); font-size: 2rem; margin-bottom: 1rem;">₹0<span style="font-size: 1rem;">/month</span></h3>
                    <ul style="margin: 1rem 0; color: var(--text-secondary);">
                        <li>✓ Access to basic courses</li>
                        <li>✓ Basic lab access</li>
                        <li>✓ Free tools only</li>
                        <li>✗ No advanced content</li>
                        <li>✗ No expert tools</li>
                    </ul>
                    <button class="btn" disabled>Current Plan</button>
                </div>
            </div>

            <div class="card" style="border: 1px solid var(--accent-secondary);">
                <h2 class="card-title">Pro</h2>
                <div class="card-content">
                    <h3 style="color: var(--accent-primary); font-size: 2rem; margin-bottom: 1rem;">₹499<span style="font-size: 1rem;">/month</span></h3>
                    <ul style="margin: 1rem 0; color: var(--text-secondary);">
                        <li>✓ All free features</li>
                        <li>✓ Access to Pro courses</li>
                        <li>✓ Intermediate labs</li>
                        <li>✓ Pro tools access</li>
                        <li>✗ No elite content</li>
                    </ul>
                    <button class="btn" onclick="initiatePayment('pro', 49900)">Upgrade to Pro</button>
                </div>
            </div>

            <div class="card" style="border: 1px solid var(--accent-primary);">
                <h2 class="card-title">Elite</h2>
                <div class="card-content">
                    <h3 style="color: var(--accent-primary); font-size: 2rem; margin-bottom: 1rem;">₹999<span style="font-size: 1rem;">/month</span></h3>
                    <ul style="margin: 1rem 0; color: var(--text-secondary);">
                        <li>✓ All Pro features</li>
                        <li>✓ Access to Elite courses</li>
                        <li>✓ Advanced & Expert labs</li>
                        <li>✓ Elite tools access</li>
                        <li>✓ Priority support</li>
                    </ul>
                    <button class="btn" onclick="initiatePayment('elite', 99900)">Upgrade to Elite</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Payment Information</h2>
            <div class="card-content">
                <p>Secure payment processing powered by Razorpay. All transactions are encrypted and secure.</p>
                <p>Your subscription will auto-renew monthly until canceled.</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-links">
            <a href="terms.html">Terms</a>
            <a href="privacy.html">Privacy</a>
            <a href="ethics.html">Ethics</a>
        </div>
        <p>&copy; 2026 VoidX Security Labs. All content for educational and ethical purposes only.</p>
    </footer>

    <script src="js/auth.js"></script>
    <script>
        // Upgrade functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Update current level display
            if (currentUser && currentUser.profile) {
                document.getElementById('current-level').textContent = (currentUser.profile.role || 'FREE').toUpperCase();
            }
            
            // Terminal functionality for upgrade page
            const terminalInput = document.getElementById('terminal-input');
            const terminalOutput = document.getElementById('terminal-output');
            
            terminalInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const command = terminalInput.value.trim().toLowerCase();
                    terminalOutput.innerHTML += `<div><span class="terminal-text">$ ${command}</span></div>`;
                    
                    switch(command) {
                        case 'help':
                            terminalOutput.innerHTML += `<div><span class="terminal-text">Available commands: help, back, dashboard</span></div>`;
                            break;
                        case 'back':
                            window.location.href = 'dashboard.html';
                            break;
                        case 'dashboard':
                            window.location.href = 'dashboard.html';
                            break;
                        case 'clear':
                            terminalOutput.innerHTML = '';
                            break;
                        default:
                            terminalOutput.innerHTML += `<div><span class="terminal-text">Command not found: ${command}. Type 'help' for available commands.</span></div>`;
                    }
                    
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    terminalInput.value = '';
                }
            });
        });
        
        // Razorpay payment integration
        async function initiatePayment(plan, amount) {
            if (!currentUser) {
                alert('Please log in to upgrade your subscription.');
                return;
            }
            
            // In a real implementation, you would call your backend to create an order
            // For demo purposes, we'll simulate the process
            const options = {
                key: 'YOUR_RAZORPAY_KEY', // Replace with your actual Razorpay key
                amount: amount, // Amount in paise (49900 paise = ₹499)
                currency: 'INR',
                name: 'VoidX Security Labs',
                description: `Subscription to ${plan.toUpperCase()} plan`,
                order_id: 'ORDER_ID', // This would come from your backend
                handler: async function(response) {
                    // Handle successful payment
                    await handlePaymentSuccess(response, plan);
                },
                prefill: {
                    email: currentUser.email,
                    contact: '', // You can collect this from the user
                },
                theme: {
                    color: '#00ff9c',
                },
            };
            
            // Show a message about backend integration needed
            alert('In a real implementation, this would connect to your backend to create a Razorpay order and process the payment. The payment would then be verified via webhook.');
            
            // For demo purposes, simulate a successful payment
            setTimeout(async () => {
                await handlePaymentSuccess({
                    razorpay_payment_id: 'demo_payment_id',
                    razorpay_order_id: 'demo_order_id',
                    razorpay_signature: 'demo_signature'
                }, plan);
            }, 1000);
        }
        
        // Handle successful payment
        async function handlePaymentSuccess(response, plan) {
            // In a real implementation, you would:
            // 1. Send the payment details to your backend for verification
            // 2. Update the user's subscription in the database
            // 3. Update the user's role based on the new subscription
            
            // For demo purposes, we'll update the UI and simulate the subscription update
            document.getElementById('terminal-output').innerHTML += `<div><span class="terminal-text">Payment successful! Processing subscription upgrade...</span></div>`;
            
            // Simulate updating the subscription in the database
            try {
                // Update subscription in Supabase
                const { error } = await supabase
                    .from('subscriptions')
                    .upsert([{
                        user_id: currentUser.id,
                        plan: plan,
                        status: 'active',
                        expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30 days from now
                    }], { onConflict: 'user_id' });
                
                if (error) {
                    console.error('Error updating subscription:', error);
                    document.getElementById('terminal-output').innerHTML += `<div><span class="terminal-text">Error updating subscription: ${error.message}</span></div>`;
                    return;
                }
                
                // Update user profile with new role
                const newRole = plan === 'pro' ? 'pro' : 'elite';
                const { error: profileError } = await supabase
                    .from('users')
                    .update({ role: newRole })
                    .eq('id', currentUser.id);
                
                if (profileError) {
                    console.error('Error updating user role:', profileError);
                    document.getElementById('terminal-output').innerHTML += `<div><span class="terminal-text">Error updating user role: ${profileError.message}</span></div>`;
                    return;
                }
                
                // Update current user's profile
                currentUser.profile.role = newRole;
                if (!currentUser.subscription) currentUser.subscription = {};
                currentUser.subscription.plan = plan;
                currentUser.subscription.status = 'active';
                
                document.getElementById('terminal-output').innerHTML += `<div><span class="terminal-text">Subscription upgraded to ${plan.toUpperCase()} successfully!</span></div>`;
                document.getElementById('terminal-output').innerHTML += `<div><span class="terminal-text">Your new access level is now active.</span></div>`;
                
                // Update the current level display
                document.getElementById('current-level').textContent = plan.toUpperCase();
                
                // Show success message
                setTimeout(() => {
                    alert(`Successfully upgraded to ${plan.toUpperCase()} plan! Your access has been updated.`);
                    window.location.reload();
                }, 2000);
            } catch (error) {
                console.error('Error processing subscription:', error);
                document.getElementById('terminal-output').innerHTML += `<div><span class="terminal-text">Error processing subscription: ${error.message}</span></div>`;
            }
        }
    </script>
</body>
</html>